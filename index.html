<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FlareLink + Games</title>
<link rel="icon" href="https://daydreamx.pro/favicon.ico" />
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #000;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }

  /* Particles container covers whole background */
  #particles-js {
    position: fixed;
    width: 100%;
    height: 100%;
    z-index: 0;
    background: #000;
  }

  /* Wrapper flex container */
  .container {
    display: flex;
    height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* Sidebar styles */
  aside.sidebar {
    width: 260px;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-right: 1px solid rgba(255,255,255,0.05);
    display: flex;
    flex-direction: column;
  }

  aside.sidebar header {
    padding: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    user-select: none;
  }

  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .tabs button {
    flex: 1;
    background: transparent;
    border: none;
    padding: 1rem 0;
    color: #ddd;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.25s ease;
    user-select: none;
    border-bottom: 3px solid transparent;
  }
  .tabs button.active,
  .tabs button:hover {
    color: #7c3aed;
    border-bottom-color: #7c3aed;
  }

  /* Search Bar */
  .search-bar {
    display: flex;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  .search-bar input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    background: rgba(255,255,255,0.05);
    color: #eee;
    outline: none;
    transition: background 0.2s ease;
  }
  .search-bar input::placeholder {
    color: #aaa;
  }
  .search-bar input:focus {
    background: rgba(124, 58, 237, 0.15);
  }
  .search-bar button {
    margin-left: 0.5rem;
    background: transparent;
    border: none;
    color: #aaa;
    font-size: 1.25rem;
    cursor: pointer;
    user-select: none;
  }
  .search-bar button:hover {
    color: #7c3aed;
  }

  /* Cards grid */
  .cards-grid {
    padding: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(115px, 1fr));
    gap: 12px;
    overflow-y: auto;
    height: calc(100vh - 130px);
  }
  .card {
    background: rgba(124, 58, 237, 0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 12px;
    padding: 1rem 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.15s ease;
    box-shadow: 0 2px 10px rgba(124, 58, 237, 0.2);
    user-select: none;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .card:hover,
  .card:focus {
    background: rgba(124, 58, 237, 0.3);
    transform: translateY(-3px);
    outline: none;
  }
  .card img.favicon {
    width: 44px;
    height: 44px;
    margin-bottom: 0.6rem;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.6));
  }
  .card .label {
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
    color: #eee;
    user-select: none;
  }

  /* Main content area */
  main.content {
    flex: 1;
    position: relative;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    display: flex;
    flex-direction: column;
  }

  /* Games iframe */
  iframe#games-iframe {
    flex: 1;
    border: none;
    width: 100%;
    height: 100%;
  }

  /* Iframe overlay */
  .iframe-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    display: flex;
    flex-direction: column;
    z-index: 9999;
  }
  .iframe-header {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 0.8rem 1rem;
    background: rgba(20, 0, 40, 0.5);
    border-bottom: 1px solid rgba(124, 58, 237, 0.4);
  }
  .iframe-header button {
    background: transparent;
    border: none;
    color: #eee;
    font-size: 1.4rem;
    margin-right: 1rem;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s ease;
  }
  .iframe-header button:hover {
    color: #7c3aed;
  }
  .iframe-header .title {
    font-weight: 700;
    font-size: 1.1rem;
    color: #ddd;
    user-select: none;
    flex: 1;
  }
  .iframe-overlay iframe {
    flex: 1;
    border: none;
    width: 100%;
    height: 100%;
    background: #000;
  }

  /* Scrollbar styles */
  ::-webkit-scrollbar {
    width: 10px;
  }
  ::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(124, 58, 237, 0.7);
    border-radius: 5px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(124, 58, 237, 0.9);
  }
</style>
</head>
<body>

<div id="particles-js"></div>

<div class="container" role="application">
  <aside class="sidebar" role="complementary" aria-label="Sidebar navigation">
    <header>FlareLink</header>
    <nav class="tabs" role="tablist">
      <button id="tab-games" role="tab" aria-selected="false" tabindex="0" aria-controls="games-iframe">Games</button>
      <button id="tab-flarelink" role="tab" aria-selected="false" tabindex="-1" aria-controls="cards-container">FlareLink</button>
    </nav>
    <div class="search-bar" id="search-bar" style="display:none;">
      <input id="search-input" type="search" placeholder="Search..." aria-label="Search FlareLink cards" autocomplete="off" />
      <button id="clear-search" aria-label="Clear search">&times;</button>
    </div>
  </aside>

  <main class="content">
    <div id="cards-container" class="cards-grid" role="list" aria-live="polite" aria-atomic="true" style="display:none;"></div>
    <iframe id="games-iframe" src="https://nullxiety.com/" title="Games" sandbox="allow-scripts allow-same-origin allow-popups allow-forms" style="display:none;"></iframe>

    <section class="iframe-overlay" id="iframe-overlay" hidden role="dialog" aria-modal="true" aria-label="FlareLink site viewer">
      <div class="iframe-header">
        <button id="refresh-btn" aria-label="Refresh iframe" title="Refresh iframe">&#x21bb;</button>
        <button id="close-btn" aria-label="Close iframe" title="Close iframe">&times;</button>
        <div class="title" id="iframe-title" aria-live="polite" aria-atomic="true"></div>
      </div>
      <iframe id="iframe" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
    </section>
  </main>
</div>

<!-- Particles.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
(() => {
  const tabs = {
    games: document.getElementById('tab-games'),
    flarelink: document.getElementById('tab-flarelink'),
  };
  const gamesIframe = document.getElementById('games-iframe');
  const cardsContainer = document.getElementById('cards-container');
  const searchBar = document.getElementById('search-bar');
  const searchInput = document.getElementById('search-input');
  const clearSearchBtn = document.getElementById('clear-search');
  const iframeOverlay = document.getElementById('iframe-overlay');
  const iframe = document.getElementById('iframe');
  const iframeTitle = document.getElementById('iframe-title');
  const closeBtn = document.getElementById('close-btn');
  const refreshBtn = document.getElementById('refresh-btn');

  // FlareLink cards data
  const cardsData = [
    {
      id: 'space',
      label: 'Space',
      wildcard: '*.space',
      favicon: 'https://googleslides.global.ssl.fastly.net/favicon.ico',
      baseUrl: 'cdn.cloudflare.net',
    },
    {
      id: 'daydreamx',
      label: 'DayDreamX',
      wildcard: '*.ddx',
      favicon: 'https://daydreamx.pro/assets/imgs/logo.png',
      baseUrl: 'cdn.cloudflare.net',
    },
    {
      id: 'terbium',
      label: 'Terbium OS',
      wildcard: '*.tb',
      favicon: 'https://terbium-46q.pages.dev/favicon.ico',
      baseUrl: 'cdn.cloudflare.net',
    },
    {
      id: 'nebulapro',
      label: 'Nebula Pro',
      wildcard: '*.nb',
      favicon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/Nebula_Hubble_2008-04-15.jpg/120px-Nebula_Hubble_2008-04-15.jpg',
      baseUrl: 'cdn.cloudflare.net',
    },
    {
      id: 'lunar',
      label: 'Lunar',
      wildcard: '*.lunar',
      favicon: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/FullMoon2010.jpg/120px-FullMoon2010.jpg',
      baseUrl: 'cdn.cloudflare.net',
    },
    {
      id: 'daydreamx-alt',
      label: 'DayDreamX Alt',
      wildcard: '*.ddx',
      favicon: 'https://daydreamx.pro/assets/imgs/logo.png',
      baseUrl: 'cdn.cloudflare.net',
    },
  ];

  // Supported domains list
  const domains = [
    'blocksi.lol',
    'deltamath.icu',
    'desmosgraphing.xyz',
    'desmos.lol',
    'edpuzzle.icu',
    'goguardian.pro',
    'googledrive.icu',
    'nearpod.lol',
    'prodigy.it.com',
    'stayinschooleducation.org',
    'studentvue.my'
  ];

  let currentTab = null;
  let currentIframeUrl = null;
  let usageOrder = [];

  // Save/load last tab
  function saveLastTab(tab) {
    localStorage.setItem('lastTab', tab);
  }
  function loadLastTab() {
    return localStorage.getItem('lastTab');
  }

  // Save/load usage order for cards
  function saveUsageOrder() {
    localStorage.setItem('usageOrder', JSON.stringify(usageOrder));
  }
  function loadUsageOrder() {
    const data = localStorage.getItem('usageOrder');
    if (data) {
      try {
        const parsed = JSON.parse(data);
        if (Array.isArray(parsed)) return parsed;
      } catch {}
    }
    return [];
  }

  // Generate random string for subdomain
  function randomString(length = 7) {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for(let i=0; i<length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Generate unique URL avoiding repeats
  function generateUniqueUrl(card) {
    let url = '';
    let tries = 0;
    do {
      const domain = domains[Math.floor(Math.random() * domains.length)];
      const subdomain = randomString(7);
      url = `https://${subdomain}.${card.wildcard.substring(2)}.${domain}.${card.baseUrl}`;
      tries++;
      if(tries > 50) break; // avoid infinite loop in extreme cases
    } while (usageOrder.includes(url));
    usageOrder.unshift(url);
    if(usageOrder.length > 50) usageOrder.pop();
    saveUsageOrder();
    return url;
  }

  // Render cards with favicon and label, and themed background
  function renderCards() {
    // Load usage order to sort cards accordingly (most recent first)
    usageOrder = loadUsageOrder();

    // Sort cards based on usage order: cards with recent URLs first, otherwise default order
    const cardsSorted = [...cardsData].sort((a,b) => {
      const aIdx = usageOrder.findIndex(u => u.includes(a.wildcard.substring(2)));
      const bIdx = usageOrder.findIndex(u => u.includes(b.wildcard.substring(2)));
      if(aIdx === -1 && bIdx === -1) return 0;
      if(aIdx === -1) return 1;
      if(bIdx === -1) return -1;
      return aIdx - bIdx;
    });

    cardsContainer.innerHTML = '';
    cardsSorted.forEach(card => {
      const cardEl = document.createElement('button');
      cardEl.className = 'card';
      cardEl.setAttribute('role', 'listitem');
      cardEl.setAttribute('aria-label', `Open ${card.label}`);
      cardEl.tabIndex = 0;

      const img = document.createElement('img');
      img.className = 'favicon';
      img.alt = `${card.label} favicon`;
      img.src = card.favicon;
      img.onerror = () => {
        img.src = 'https://via.placeholder.com/44?text=?';
      };

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = card.label;

      cardEl.appendChild(img);
      cardEl.appendChild(label);

      cardEl.addEventListener('click', () => {
        openIframe(card);
      });

      cardsContainer.appendChild(cardEl);
    });
  }

  // Open iframe overlay with generated url
  function openIframe(card) {
    currentIframeUrl = generateUniqueUrl(card);
    iframe.src = currentIframeUrl;
    iframeTitle.textContent = card.label;
    iframeOverlay.hidden = false;
    iframe.focus();

    // Save usage to reorder cards
    usageOrder.unshift(currentIframeUrl);
    if (usageOrder.length > 50) usageOrder.pop();
    saveUsageOrder();
    renderCards();
  }

  // Tab switching logic
  function setActiveTab(tabId) {
    if (currentTab === tabId) return;
    currentTab = tabId;

    if (tabId === 'games') {
      tabs.games.setAttribute('aria-selected', 'true');
      tabs.games.tabIndex = 0;
      tabs.flarelink.setAttribute('aria-selected', 'false');
      tabs.flarelink.tabIndex = -1;
      gamesIframe.style.display = 'block';
      cardsContainer.style.display = 'none';
      searchBar.style.display = 'none';
      iframeOverlay.hidden = true;
      iframe.src = '';
    } else if (tabId === 'flarelink') {
      tabs.flarelink.setAttribute('aria-selected', 'true');
      tabs.flarelink.tabIndex = 0;
      tabs.games.setAttribute('aria-selected', 'false');
      tabs.games.tabIndex = -1;
      gamesIframe.style.display = 'none';
      cardsContainer.style.display = 'grid';
      searchBar.style.display = 'flex';
      iframeOverlay.hidden = true;
      iframe.src = '';
    }
    saveLastTab(tabId);
  }

  // Filter cards based on search input
  function filterCards(query) {
    const q = query.trim().toLowerCase();
    const cards = cardsContainer.children;
    for (const cardEl of cards) {
      const label = cardEl.querySelector('.label').textContent.toLowerCase();
      if (label.includes(q)) {
        cardEl.style.display = '';
      } else {
        cardEl.style.display = 'none';
      }
    }
  }

  // Close iframe overlay
  closeBtn.addEventListener('click', () => {
    iframeOverlay.hidden = true;
    iframe.src = '';
  });

  // Refresh iframe with new unique URL for same card
  refreshBtn.addEventListener('click', () => {
    if (!currentIframeUrl) return;
    // Find the card for current iframe url
    const matchedCard = cardsData.find(card => currentIframeUrl.includes(card.wildcard.substring(2)));
    if (!matchedCard) return;
    currentIframeUrl = generateUniqueUrl(matchedCard);
    iframe.src = currentIframeUrl;
    iframeTitle.textContent = matchedCard.label;

    usageOrder.unshift(currentIframeUrl);
    if (usageOrder.length > 50) usageOrder.pop();
    saveUsageOrder();
    renderCards();
  });

  // Search bar event
  searchInput.addEventListener('input', () => {
    filterCards(searchInput.value);
  });
  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterCards('');
    searchInput.focus();
  });

  // Tabs event listeners
  tabs.games.addEventListener('click', () => setActiveTab('games'));
  tabs.flarelink.addEventListener('click', () => setActiveTab('flarelink'));

  // Initialize
  renderCards();
  const savedTab = loadLastTab();
  setActiveTab(savedTab === 'games' ? 'games' : 'flarelink');

  // Initialize particles.js with smooth purple-blue style like before
  particlesJS('particles-js', {
    "particles": {
      "number": {
        "value": 60,
        "density": {
          "enable": true,
          "value_area": 800
        }
      },
      "color": {
        "value": ["#7c3aed", "#4c51bf", "#3b82f6"]
      },
      "shape": {
        "type": "circle",
        "stroke": { "width": 0, "color": "#000000" }
      },
      "opacity": {
        "value": 0.35,
        "random": true,
        "anim": {
          "enable": true,
          "speed": 1,
          "opacity_min": 0.15,
          "sync": false
        }
      },
      "size": {
        "value": 4,
        "random": true,
        "anim": {
          "enable": false
        }
      },
      "line_linked": {
        "enable": true,
        "distance": 140,
        "color": "#7c3aed",
        "opacity": 0.3,
        "width": 1
      },
      "move": {
        "enable": true,
        "speed": 1.2,
        "direction": "none",
        "random": false,
        "straight": false,
        "out_mode": "bounce",
        "bounce": true,
        "attract": { "enable": false }
      }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": {
        "onhover": { "enable": true, "mode": "grab" },
        "onclick": { "enable": true, "mode": "push" },
        "resize": true
      },
      "modes": {
        "grab": { "distance": 140, "line_linked": { "opacity": 0.5 } },
        "push": { "particles_nb": 4 }
      }
    },
    "retina_detect": true
  });

})();
</script>

</body>
</html>
