<div class="wiki-links-tool">
  <div class="max-w-4xl mx-auto p-4">
    <h2 class="text-3xl font-bold text-center mb-6">ğŸŒ Wiki-Links Browser (2.0)</h2>
    <h3 class="text-1xl font-light text-center mb-3">ğŸ‘ŠÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ï®©Ù¨Ù€â¤ï¸MADE BY RUSTY-NAIL</h3>
    <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-4">
      <label class="flex flex-col w-full md:w-1/3">
        <span class="text-sm font-semibold mb-1">Filter by Name</span>
        <select id="filter-name" class="rounded border-gray-300 p-2 focus:ring-blue-500"><option value="">All</option><option value="Rammerhead">Rammerhead</option><option value="Interstellar">Interstellar</option><option value="Shuttle">Shuttle</option><option value="Utopia">Utopia</option><option value="Doge">Doge</option><option value="Shadow">Shadow</option><option value="Space">Space</option><option value="DayDreamX">DayDreamX</option><option value="Bolt">Bolt</option><option value="SKrypt">SKrypt</option><option value="Reds Exploit Corner">Reds Exploit Corner</option></select>
      </label>

      <label class="flex flex-col w-full md:w-1/3">
        <span class="text-sm font-semibold mb-1">Filter by Date</span>
        <select id="filter-date" class="rounded border-gray-300 p-2 focus:ring-blue-500">
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="last7">Last 7 Days</option>
          <option value="thisMonth">This Month</option>
          <option value="lastMonth">Last Month</option>
          <option value="thisYear">This Year</option>
          <option value="all" selected="">All Time</option>
        </select>
      </label>

      <button id="search-btn" class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 mt-2 md:mt-0 rounded hover:bg-blue-700 transition">
        ğŸ” Search
      </button>
    </div>

    <div class="text-right mb-3" id="copy-all-container">
      <button id="copy-all-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
        ğŸ“‹ Copy All Visible URLs
      </button>
    </div>

    <div id="results" class="space-y-4"><div class="bg-white p-4 rounded shadow hover:shadow-md transition">
          <h3 class="text-lg font-semibold mb-1">Shuttle (2025-08-29)</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="https://best-force-734.nowgg.me/" target="_blank" class="text-blue-600 underline break-words max-w-full">https://best-force-734.nowgg.me/</a>
            <button onclick="copySingleLink('https://best-force-734.nowgg.me/')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('5721dfa9-f38d-4af4-8edc-b1a027a055d7', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>0</span></button>
            <button onclick="rateLink('5721dfa9-f38d-4af4-8edc-b1a027a055d7', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>7</span></button>
          </div></div><div class="bg-white p-4 rounded shadow hover:shadow-md transition">
          <h3 class="text-lg font-semibold mb-1">Shuttle (2025-08-29)</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="https://calm-soul-501.sz.games/" target="_blank" class="text-blue-600 underline break-words max-w-full">https://calm-soul-501.sz.games/</a>
            <button onclick="copySingleLink('https://calm-soul-501.sz.games/')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('bcf837d7-423e-4f48-ba0b-027f145dbe32', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>0</span></button>
            <button onclick="rateLink('bcf837d7-423e-4f48-ba0b-027f145dbe32', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>2</span></button>
          </div></div><div class="bg-white p-4 rounded shadow hover:shadow-md transition">
          <h3 class="text-lg font-semibold mb-1">Shuttle (2025-08-29)</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="https://wide-heart-891.discovergeographics.com/" target="_blank" class="text-blue-600 underline break-words max-w-full">https://wide-heart-891.discovergeographics.com/</a>
            <button onclick="copySingleLink('https://wide-heart-891.discovergeographics.com/')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('f9f3cb6b-c9e2-4da6-bd7b-23c35b0f6f50', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>3</span></button>
            <button onclick="rateLink('f9f3cb6b-c9e2-4da6-bd7b-23c35b0f6f50', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>4</span></button>
          </div></div><div class="bg-white p-4 rounded shadow hover:shadow-md transition">
          <h3 class="text-lg font-semibold mb-1">Shuttle (2025-08-29)</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="https://new-hawk-791.scientificsense.org/" target="_blank" class="text-blue-600 underline break-words max-w-full">https://new-hawk-791.scientificsense.org/</a>
            <button onclick="copySingleLink('https://new-hawk-791.scientificsense.org/')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('1b06f595-d9f7-4d18-980f-bed7a16fb843', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>1</span></button>
            <button onclick="rateLink('1b06f595-d9f7-4d18-980f-bed7a16fb843', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>1</span></button>
          </div></div><div class="bg-white p-4 rounded shadow hover:shadow-md transition">
          <h3 class="text-lg font-semibold mb-1">Shuttle (2025-08-29)</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="https://sunny-hawk-220.3kh0.org/" target="_blank" class="text-blue-600 underline break-words max-w-full">https://sunny-hawk-220.3kh0.org/</a>
            <button onclick="copySingleLink('https://sunny-hawk-220.3kh0.org/')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('7665815f-2554-4679-b39a-9ed1d7014d98', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>1</span></button>
            <button onclick="rateLink('7665815f-2554-4679-b39a-9ed1d7014d98', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>2</span></button>
          </div></div></div>

    <div class="flex justify-between items-center mt-6" id="pagination-controls">
      <button id="prev-links" class="bg-gray-600 text-white px-5 py-2 rounded hover:bg-gray-700 transition" disabled="">â¬…ï¸ Previous Links</button>
      <button id="next-links" class="bg-gray-600 text-white px-5 py-2 rounded hover:bg-gray-700 transition">Next Links â¡ï¸</button>
    </div>
  </div>

  <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded shadow-lg hidden z-50">
    âœ… Rated successfully!
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://ylbeucokkfotgghbveuv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsYmV1Y29ra2ZvdGdnaGJ2ZXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ0MjU5MjksImV4cCI6MjA2MDAwMTkyOX0.EM52Z8YVA4xuCnNPLrAuweJq652QAPa3AjxjNRIrxE8'
    );

    let page = 0;
    const pageSize = 5;
    let currentFilter = { name: '', range: 'all' };
    let totalLinks = 0;

    document.getElementById('search-btn').addEventListener('click', applyFilters);
    document.getElementById('next-links').addEventListener('click', () => { page++; fetchLinks(); });
    document.getElementById('prev-links').addEventListener('click', () => { page--; fetchLinks(); });
    document.getElementById('copy-all-btn').addEventListener('click', copyAllVisibleLinks);

    function showSpinner() {
      document.getElementById('loading-spinner').classList.remove('hidden');
    }

    function hideSpinner() {
      document.getElementById('loading-spinner').classList.add('hidden');
    }

    function showToast(message = 'Action completed!') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 2000);
    }

    async function loadNames() {
      const { data } = await supabase.from('link_names').select('name');
      const select = document.getElementById('filter-name');
      select.innerHTML = `<option value="">All</option>`;
      data?.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name;
        opt.textContent = d.name;
        select.appendChild(opt);
      });
    }

    function getDateRange(rangeType) {
      const now = new Date();
      const start = new Date();
      const end = new Date();
      switch (rangeType) {
        case 'today': start.setHours(0, 0, 0, 0); return { start, end: now };
        case 'yesterday': start.setDate(start.getDate() - 1); end.setDate(end.getDate() - 1); start.setHours(0, 0, 0, 0); end.setHours(23, 59, 59, 999); return { start, end };
        case 'last7': start.setDate(start.getDate() - 6); return { start, end: now };
        case 'thisMonth': start.setDate(1); return { start, end: now };
        case 'lastMonth': start.setMonth(start.getMonth() - 1); start.setDate(1); end.setMonth(end.getMonth() - 1); end.setDate(new Date(end.getFullYear(), end.getMonth() + 1, 0).getDate()); end.setHours(23, 59, 59, 999); return { start, end };
        case 'thisYear': start.setMonth(0, 1); start.setHours(0, 0, 0, 0); return { start, end: now };
        default: return null;
      }
    }

    async function applyFilters() {
      page = 0;
      currentFilter.name = document.getElementById('filter-name').value;
      currentFilter.range = document.getElementById('filter-date').value;
      await countTotalLinks();
      await fetchLinks();
    }

    async function countTotalLinks() {
      let query = supabase.from('links').select('*', { count: 'exact', head: true });
      if (currentFilter.name) query = query.eq('name', currentFilter.name);
      const range = getDateRange(currentFilter.range);
      if (range) {
        query = query.gte('date', range.start.toISOString().split('T')[0]).lte('date', range.end.toISOString().split('T')[0]);
      }
      const { count } = await query;
      totalLinks = count || 0;
    }

    async function fetchLinks() {
      showSpinner();
      const container = document.getElementById('results');
      container.innerHTML = '';

      let query = supabase
        .from('links')
        .select('*')
        .order('date', { ascending: false })
        .range(page * pageSize, (page + 1) * pageSize - 1);

      if (currentFilter.name) query = query.eq('name', currentFilter.name);
      const range = getDateRange(currentFilter.range);
      if (range) {
        query = query.gte('date', range.start.toISOString().split('T')[0]).lte('date', range.end.toISOString().split('T')[0]);
      }

      const { data, error } = await query;
      hideSpinner();

      if (error || !data || data.length === 0) {
        container.innerHTML = `<div class="bg-yellow-100 text-yellow-800 p-4 rounded shadow text-center">âš ï¸ No links found.</div>`;
        document.getElementById('copy-all-container').classList.add('hidden');
        document.getElementById('pagination-controls').classList.add('hidden');
        return;
      }

      for (const link of data) {
        const { count: upCount } = await supabase.from('ratings_up').select('*', { count: 'exact', head: true }).eq('link_id', link.id);
        const { count: downCount } = await supabase.from('ratings_down').select('*', { count: 'exact', head: true }).eq('link_id', link.id);
        const formattedDate = new Date(link.date).toISOString().split('T')[0];

        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded shadow hover:shadow-md transition';
        div.innerHTML = `
          <h3 class="text-lg font-semibold mb-1">${link.name} (${formattedDate})</h3>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <a href="${link.url}" target="_blank" class="text-blue-600 underline break-words max-w-full">${link.url}</a>
            <button onclick="copySingleLink('${link.url}')" class="text-sm bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">ğŸ“‹ Copy</button>
          </div>
          <div class="flex items-center gap-4 mt-3 text-sm">
            <button onclick="rateLink('${link.id}', 'up', this)" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-800 px-3 py-1 rounded">âœ… <span>${upCount || 0}</span></button>
            <button onclick="rateLink('${link.id}', 'down', this)" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">âŒ <span>${downCount || 0}</span></button>
          </div>`;
        container.appendChild(div);
      }

      document.getElementById('copy-all-container').classList.remove('hidden');
      const prevBtn = document.getElementById('prev-links');
      const nextBtn = document.getElementById('next-links');
      const pagination = document.getElementById('pagination-controls');
      pagination.classList.remove('hidden');
      prevBtn.disabled = page === 0;
      nextBtn.disabled = (page + 1) * pageSize >= totalLinks;
    }

    async function rateLink(linkId, direction, btn) {
      const table = direction === 'up' ? 'ratings_up' : 'ratings_down';
      await supabase.from(table).insert({ link_id: linkId });
      const countSpan = btn.querySelector('span');
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
      showToast(direction === 'up' ? 'âœ… Upvoted!' : 'âŒ Downvoted!');
    }

    function copySingleLink(url) {
      navigator.clipboard.writeText(url);
      showToast('ğŸ“‹ Link copied!');
    }

    function copyAllVisibleLinks() {
      const links = document.querySelectorAll('#results a');
      const urls = Array.from(links).map(a => a.href).join('\n');
      navigator.clipboard.writeText(urls);
      showToast('ğŸ“‹ All visible links copied!');
    }

    loadNames();
    applyFilters();
  </script>
</div>
